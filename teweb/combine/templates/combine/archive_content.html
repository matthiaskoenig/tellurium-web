{% import 'combine/macros.html' as macros %}

<div class="panel panel-default">
   <!-- navigate archives -->
    <a href="{{ url('combine:archive_previous', args=[archive.id]) }}"
       title="Previous archive"><span class="btn-xs btn-primary"><i
            class="fa fa-arrow-circle-o-left fa-fw"></i></span></a>
    <a href="{{ url('combine:archive_next', args=[archive.id]) }}"
       title="Next archive"><span class="btn-xs btn-primary"><i
            class="fa fa-arrow-circle-o-right fa-fw"></i></span></a>
    <div class="panel-heading">

        <h2 class="panel-title">
            <a href="{{ url('combine:archive', args=[archive.id]) }}">
                {{ macros.archive_html(archive) }}
            <a href="{{ url('combine:download_archive', args=[archive.id]) }}" title="Download archive"><i
                    class="fa fa-download fa-fw"></i></a>

            <span class="pull-right">
                <!-- delete archive -->
                {% if request.user.is_authenticated %}
                <a href="{{ url('combine:delete_archive', args=[archive.id]) }}" title="Delete archive {{ archive.id }}: {{ archive.name }}"><span class="btn-xs btn-danger"
                                                                                                              onclick="return confirm('Are you sure you want to delete: {{ archive }}?')">
                    <i class="fa fa-trash fa-fw"></i></span></a>
                {% endif %}
            </span>
        </h2>
    </div>
    <div class="panel-body">
        {% if archive.has_entries() %}
            <table id="entries" class="table table-striped table-condensed table-hover">
                <thead>
                <tr>
                    <th class="hidden hidden-xs"></th>
                    <th>master</th>
                    <th>icon</th>
                    <th>format</th>
                    <th>location</th>
                    <th class="hidden">name</th>

                </tr>
                </thead>
                {% for entry in archive.entries.all()  %}
                    <tr id="archive_content">
                        <td class="hidden hidden-xs"><span class="badge">{{ loop.index }}</span></td>
                        <td>{% if entry.master %}
                            <i class="fa fa-star fa-fw" title="master"></i>
                        {% endif %}
                        </td>
                        <td>
                            {% if entry.base_format in ['cellml', 'sed-ml', 'sbml', 'numl', 'csv', 'sbgn', 'omex', 'omex-manifest', 'omex-metadata'] %}
                                <img height=20 title="{{ entry.format }}"
                                     src="{{ static('combine/images/mediatype/')}}{{ entry.base_format }}.png">
                            {% endif %}
                        </td>
                        <td>
                            <code title="{{ entry.format }}">{{ entry.short_format }}</code>
                        </td>
                        <td class="location">
                            {% if entry.location in ['.'] %}
                                {{ entry.location}}
                            {% else %}
                                <a href="{{ entry.file.url }}"
                                   target="_blank">{{ entry.location }}</a>
                            {% endif %}
                        </td>
                        <td class="hidden" id="name"> {{entry.name}}</td>

                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <p>No entries in archive metadata.</p>
        {% endif %}

        <span class="label label-primary" title="ZIP Content">zip content</span>
        <div class="row">
            <!-- The zip tree -->
            <div class="col-sm-6" id="json_tree"></div>

            <!-- the entry detail -->
            <div class="col-sm-6" id="entry_detail">
                <form id="form_detail" method="post">
                    <div id="button-div"></div>
                    <div id="manifest_detail">
                    </div>
                    <div id="item_detail"></div>
                </form>
            </div>
            
        </div>

        <!-- idea dump
        <div id="include"><iframe name="FileFrame" scrolling="yes" width="600" height="600"></iframe></div>
        <script type="text/javascript">
            $("#link").click(function(){
                frames['FileFrame'].location.href="https://www.test.de"
            });
        </script>
        -->

    </div>
</div>


<script>
    // load zip tree
    var endpoint = './zip_tree';
    $.ajax({
        method: "GET",
        url: endpoint,
        success: function (data) {
            $('#json_tree').jstree({
                'core': {
                    'multiple': false,
                    'data': data
                }

            });
        },
        error: function (error_data) {
            console.log("error");
            console.log(error_data);

        }
    })
</script>

<script>
    //load detail of selected entry.
         $('#json_tree')
      // listen for event in json tree
      .on('select_node.jstree', function (e, data) {
          // get selected node

          var selected, entry_pk;
          console.log("hi");
          selected = $('#json_tree').jstree(true).get_selected(true);
          entry_pk = selected[0].original.pk;
          display_entry_detail(entry_pk, false);
        });
</script>

<script>
     // trigger on_select for selected node when tree loads
            $("#json_tree").on("ready.jstree", function(e, data) {
              var tree = data.instance;
              var obj = tree.get_selected(true)[0];

              // trigger the on_select handler for the tree node that is currently selected and ensure that it is opened
              if (obj) {
                if (obj.state.opened) {
                  tree.trigger('select_node', { 'node' : obj, 'selected' : tree._data.core.selected, 'event' : e });
                } else {
                  tree.open_node(obj, function() {
                    tree.trigger('select_node', { 'node' : obj, 'selected' : tree._data.core.selected, 'event' : e });
                  });
                }
              }
            });
</script>

<script>

    $(document).on('click','#editButton',function(){
        var selected = $('#json_tree').jstree(true).get_selected(true);
        var entry_pk = selected[0].original.pk;
        display_entry_detail(entry_pk, true);
    });

    $(document).on('click','#addCreator',function(){
        var contact_content = add_empty_creator();
        $("#item_detail").append(contact_content);
    });

    $(document).on('click','#delete',function(){
         var creatorId = this.parentNode.getElementsByClassName("Id")[0].value;
         delete_contact(this.parentNode.id,creatorId,this.parentNode.parentNode);
         this.parentNode.parentNode = this.parentNode.parentNode.removeChild(this.parentNode)
    });


</script>

<script>
    function display_entry_detail(entry_pk, edit ){
        // display detail of selected entry.
        var endpoint_path = "/api/archive-entries/" + entry_pk+"/";
        var endpoint = window.location.origin+endpoint_path;

        var manifest_detail_div_document = document.getElementById("manifest_detail");
        var button_div_document = document.getElementById("button-div");
        var entry_detail_div_document = document.getElementById("item_detail");

        manifest_detail_div_document.innerHTML ="";
        button_div_document.innerHTML ="";
        entry_detail_div_document.innerHTML ="";

        $.ajax({
            url: endpoint,
            type:'Get',
            success: function (data) {
                var metadata = data.metadata;

                button_div_document.appendChild(create_buttons_div(edit));
                manifest_detail_div_document.appendChild(create_entry_title(data));
                manifest_detail_div_document.appendChild(create_manfifest_detail(entry_pk,data,edit));

                if(metadata !== 'undefined'){
                    entry_detail_div_document.append(create_meta(metadata, edit));
                }
            },
            error: function (error_data) {
                // errors if anythink goes wrong
                console.log("error");
                console.log(error_data);
            }
        })
    }
</script>

<script>
    var frm = $('#form_detail');
    frm.submit(function () {
        document.getElementById("form_detail").appendChild(create_master_input());
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: {"data": frm.serializeJSON()},
            success: function (data) {

                // if data is not valid
                if(data.is_error){
                    for (var error in data.errors){
                        $("#item_detail").prepend("<div class='alert alert-danger' data-alert>"+error+":"+data.errors[error]+"</div>")
                    }
                }
                // if data valid
                else{
                console.log("success"); // another sanity check
                var selected = $('#json_tree').jstree(true).get_selected(true);
                var entry_pk = selected[0].original.pk;
                display_entry_detail(entry_pk,false)}

            },
            error: function(data) {
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
        return false;
    });
</script>

<script>
    var csrftoken = Cookies.get('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
</script>

