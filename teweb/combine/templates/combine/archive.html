{% extends "combine/base_generic.html" %}
{% load static %}

{% block content %}
<h1><a href="http://co.mbine.org/documents/archive" alt="COMBINE archive format" target="_blank"><img
            src="{% static 'combine/images/logos/omex.png' %}" height="40"></a> {{ archive }}</h1>

<ul>
    {% for entry in entries %}
    <li>{{ entry }}<b><code>{{entry.getLocation }}</code></b> ({{entry.getFormat}})</li>
    {% endfor %}
</ul>

<hr />
<h2>Results</h2>
<p>
<i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
<span class="sr-only">Loading...</span>
Executing <b><code>{{ archive }}</code></b>
</p>

<p>
<b>Task:</b> {{ task_id }}
</p>

  <style>
  .progress {
   width:50%;
   background:yellow;
  }
  .bar {
   height:15px;
   width:0%;
   background:tomato;
   text-align:right;
  }
 </style>

   <div class="progress_container">

   <div class="current-task">
    <h4>{% if task_id %} Task ID: {{ task_id }} {% endif %}</h4>
   </div>

   <div class="status"></div>
   {% if task_id %}
   <div class="progress">
    <div class="bar"></div>
   </div>
   {% endif %}
  </div>

 </div>

<script type="text/javascript">
    // using jQuery
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

   var poll_xhr;
   var willstop = 0;
  (function(){
    var poll = function(){
      var json_dump = "";
      var task_id = "{{ task_id }}";

      console.log(task_id);
      poll_xhr = $.ajax({
        url:'check_state',
        type: 'POST',
        data: {
            task_id: task_id,
            csrfmiddlewaretoken: csrftoken,
        },
        success: function(result) {
                    if (result.process_percent == null || result.process_percent == undefined) {
                        willstop = 1;
                        document.getElementById("user-count").textContent="DONE";
                        jQuery('.bar').css({'width': 100 + '%'});
                        jQuery('.bar').html(100 + '%');
                        document.getElementById('returnBtn').style.visibility = 'visible';

                       } else {
                         jQuery('.bar').css({'width': result.process_percent + '%'});
                         jQuery('.bar').html(result.process_percent + '%');
                         document.getElementById("user-count").textContent="PROCRESSING";
                       };
                    }
      });
    };

    var refreshIntervalId = setInterval(function() {
      poll();
      if(willstop == 1){
        clearInterval(refreshIntervalId);
      }
    },500);


  })();
</script>


{% endblock %}